---
// Meetup submission form component
// Submits to n8n webhook for automated PR creation
---

<div class="card card-body">
  <h3 class="text-xl font-semibold mb-2">Submit a Meetup</h3>
  <p class="text-sm text-neutral-600 mb-6">
    Host or propose a community meetup. Your event will be reviewed and added via GitHub PR.
  </p>

  <form id="meetup-form" class="space-y-4">
    <!-- Title -->
    <div>
      <label for="meetup-title" class="block text-sm font-medium text-neutral-700 mb-1">
        Event Title <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        id="meetup-title"
        name="title"
        required
        placeholder="e.g., Monthly Mesh Meetup - February 2026"
        class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
      />
    </div>

    <!-- Description -->
    <div>
      <label for="meetup-description" class="block text-sm font-medium text-neutral-700 mb-1">
        Description <span class="text-red-500">*</span>
      </label>
      <textarea
        id="meetup-description"
        name="description"
        required
        rows="3"
        placeholder="Brief summary of the meetup purpose and activities"
        class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
      ></textarea>
    </div>

    <!-- Content -->
    <div>
      <label for="meetup-content" class="block text-sm font-medium text-neutral-700 mb-1">
        Event Details
      </label>
      <textarea
        id="meetup-content"
        name="content"
        rows="8"
        placeholder="Optional: Additional details, agenda, what to bring, parking info, etc. (Markdown supported)"
        class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent font-mono text-sm"
      ></textarea>
      <p class="text-xs text-neutral-500 mt-1">Use Markdown formatting for rich content (optional)</p>
    </div>

    <!-- Date & Time -->
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label for="meetup-date" class="block text-sm font-medium text-neutral-700 mb-1">
          Start Date <span class="text-red-500">*</span>
        </label>
        <input
          type="datetime-local"
          id="meetup-date"
          name="date"
          required
          class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
        />
      </div>
      <div>
        <label for="meetup-endDate" class="block text-sm font-medium text-neutral-700 mb-1">
          End Date
        </label>
        <input
          type="datetime-local"
          id="meetup-endDate"
          name="endDate"
          class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
        />
      </div>
    </div>

    <!-- Location -->
    <div>
      <label for="meetup-location" class="block text-sm font-medium text-neutral-700 mb-1">
        Location Name <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        id="meetup-location"
        name="location"
        required
        placeholder="e.g., Shem Creek Park, Charleston Coffee House"
        class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
      />
    </div>

    <!-- Address -->
    <div>
      <label for="meetup-address" class="block text-sm font-medium text-neutral-700 mb-1">
        Street Address
      </label>
      <input
        type="text"
        id="meetup-address"
        name="address"
        placeholder="508 Mill St, Mount Pleasant, SC 29464"
        class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
      />
      <p class="text-xs text-neutral-500 mt-1">Full address with city and zip code (optional)</p>
    </div>

    <!-- Coordinates -->
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label for="meetup-lat" class="block text-sm font-medium text-neutral-700 mb-1">
          Latitude
        </label>
        <input
          type="number"
          id="meetup-lat"
          name="lat"
          step="0.0001"
          min="-90"
          max="90"
          placeholder="32.7765"
          class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
        />
      </div>
      <div>
        <label for="meetup-lng" class="block text-sm font-medium text-neutral-700 mb-1">
          Longitude
        </label>
        <input
          type="number"
          id="meetup-lng"
          name="lng"
          step="0.0001"
          min="-180"
          max="180"
          placeholder="-80.0298"
          class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
        />
      </div>
    </div>
    <p class="text-xs text-neutral-500">GPS coordinates for map display (optional)</p>

    <!-- RSVP Link -->
    <div>
      <label for="meetup-rsvpLink" class="block text-sm font-medium text-neutral-700 mb-1">
        RSVP Link
      </label>
      <input
        type="url"
        id="meetup-rsvpLink"
        name="rsvpLink"
        placeholder="https://eventbrite.com/your-event or Discord event link"
        class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
      />
      <p class="text-xs text-neutral-500 mt-1">Link to RSVP or get more info (optional)</p>
    </div>

    <!-- Max Attendees -->
    <div>
      <label for="meetup-maxAttendees" class="block text-sm font-medium text-neutral-700 mb-1">
        Max Attendees
      </label>
      <input
        type="number"
        id="meetup-maxAttendees"
        name="maxAttendees"
        min="1"
        placeholder="e.g., 25"
        class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
      />
      <p class="text-xs text-neutral-500 mt-1">Venue capacity limit (optional)</p>
    </div>

    <!-- Submitter Email -->
    <div>
      <label for="meetup-submitterEmail" class="block text-sm font-medium text-neutral-700 mb-1">
        Email <span class="text-red-500">*</span>
      </label>
      <input
        type="email"
        id="meetup-submitterEmail"
        name="submitterEmail"
        required
        placeholder="your.email@example.com"
        class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
      />
      <p class="text-xs text-neutral-500 mt-1">For PR notifications (not published on site)</p>
    </div>

    <!-- Error Message -->
    <div id="meetup-error-message" class="hidden p-3 bg-red-50 border border-red-200 rounded-md text-sm text-red-700"></div>

    <!-- Success Message -->
    <div id="meetup-success-message" class="hidden p-3 bg-green-50 border border-green-200 rounded-md text-sm text-green-700"></div>

    <!-- Submit Button -->
    <button
      type="submit"
      id="meetup-submit-button"
      class="btn-primary w-full"
    >
      <span id="meetup-submit-text">Submit Meetup</span>
      <span id="meetup-submit-loading" class="hidden">
        <svg class="animate-spin h-5 w-5 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Submitting...
      </span>
    </button>

    <p class="text-xs text-neutral-500 text-center">
      By submitting, you agree that your meetup information will be publicly displayed on this website.
    </p>
  </form>
</div>

<script>
  import { z } from 'zod';

  const WEBHOOK_URL = import.meta.env.PUBLIC_N8N_MEETUPS_WEBHOOK_URL;

  // Meetup schema matching content/config.ts
  const meetupSchema = z.object({
    title: z.string().min(1, 'Title is required'),
    description: z.string().min(1, 'Description is required'),
    content: z.string().optional(),
    date: z.string().min(1, 'Start date is required'),
    endDate: z.string().optional(),
    location: z.string().min(1, 'Location is required'),
    address: z.string().optional(),
    coordinates: z.object({
      lat: z.number().min(-90).max(90),
      lng: z.number().min(-180).max(180),
    }).optional(),
    rsvpLink: z.string().url('Must be a valid URL').optional().or(z.literal('')),
    maxAttendees: z.number().min(1).optional(),
    submitterEmail: z.string().email('Valid email is required'),
  });

  const form = document.getElementById('meetup-form') as HTMLFormElement;
  const submitButton = document.getElementById('meetup-submit-button') as HTMLButtonElement;
  const submitText = document.getElementById('meetup-submit-text') as HTMLSpanElement;
  const submitLoading = document.getElementById('meetup-submit-loading') as HTMLSpanElement;
  const errorMessage = document.getElementById('meetup-error-message') as HTMLDivElement;
  const successMessage = document.getElementById('meetup-success-message') as HTMLDivElement;

  function showError(message: string) {
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
    successMessage.classList.add('hidden');
  }

  function showSuccess(message: string) {
    successMessage.textContent = message;
    successMessage.classList.remove('hidden');
    errorMessage.classList.add('hidden');
  }

  function setLoading(isLoading: boolean) {
    submitButton.disabled = isLoading;
    if (isLoading) {
      submitText.classList.add('hidden');
      submitLoading.classList.remove('hidden');
    } else {
      submitText.classList.remove('hidden');
      submitLoading.classList.add('hidden');
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!WEBHOOK_URL || WEBHOOK_URL === 'https://your-n8n-instance.com/webhook/submit-meetup') {
      showError('Form submission is not configured. Please set PUBLIC_N8N_MEETUPS_WEBHOOK_URL in .env file.');
      return;
    }

    errorMessage.classList.add('hidden');
    successMessage.classList.add('hidden');

    const formData = new FormData(form);
    const lat = formData.get('lat') ? parseFloat(formData.get('lat') as string) : undefined;
    const lng = formData.get('lng') ? parseFloat(formData.get('lng') as string) : undefined;
    const coordinates = (lat !== undefined && lng !== undefined) ? { lat, lng } : undefined;

    const data = {
      title: formData.get('title') as string,
      description: formData.get('description') as string,
      content: formData.get('content') as string || undefined,
      date: formData.get('date') as string,
      endDate: formData.get('endDate') as string || undefined,
      location: formData.get('location') as string,
      address: formData.get('address') as string || undefined,
      coordinates,
      rsvpLink: formData.get('rsvpLink') as string || undefined,
      maxAttendees: formData.get('maxAttendees') ? parseInt(formData.get('maxAttendees') as string) : undefined,
      submitterEmail: formData.get('submitterEmail') as string,
    };

    try {
      meetupSchema.parse(data);
    } catch (error) {
      if (error instanceof z.ZodError) {
        const firstError = error.errors[0];
        showError(firstError.message);
      } else {
        showError('Validation failed. Please check your inputs.');
      }
      return;
    }

    setLoading(true);

    try {
      const payload = {
        ...data,
        featured: false,
        submittedAt: new Date().toISOString(),
      };

      const response = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      showSuccess('âœ“ Meetup submitted successfully! A GitHub PR will be created for review. You\'ll receive updates at your email address.');
      form.reset();
      successMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } catch (error) {
      console.error('Submission error:', error);
      showError('Failed to submit meetup. Please try again or contact us on Discord.');
    } finally {
      setLoading(false);
    }
  });
</script>
